name = "mirubato-api"
main = "src/index.ts"
compatibility_date = "2024-01-01"
compatibility_flags = ["nodejs_compat"]

[build]
command = "npm run build"

# Local development
[env.local]
vars = { ENVIRONMENT = "local", JWT_SECRET = "local-jwt-secret-for-development-only", MAGIC_LINK_SECRET = "local-magic-link-secret-for-development-only", GOOGLE_CLIENT_ID = "588179480764-kqduhkmbjh34po7kgfond5anarg1b4vm.apps.googleusercontent.com" }

[[env.local.d1_databases]]
binding = "DB"
database_name = "mirubato-dev"
database_id = "4510137a-7fdf-4fcd-83c9-a1b0adb7fe3e"

# Staging environment
[env.staging]
vars = { ENVIRONMENT = "staging", GOOGLE_CLIENT_ID = "588179480764-kqduhkmbjh34po7kgfond5anarg1b4vm.apps.googleusercontent.com" }
routes = [
  { pattern = "apiv2-staging.mirubato.com", custom_domain = true }
]

[[env.staging.d1_databases]]
binding = "DB"
database_name = "mirubato-dev"
database_id = "4510137a-7fdf-4fcd-83c9-a1b0adb7fe3e"

# Rate limiting for staging
[[env.staging.unsafe.bindings]]
name = "RATE_LIMITER"
type = "ratelimit"
namespace_id = "1234"
simple = { limit = 10, period = 60 }

# Production environment (default)
[vars]
ENVIRONMENT = "production"
GOOGLE_CLIENT_ID = "588179480764-kqduhkmbjh34po7kgfond5anarg1b4vm.apps.googleusercontent.com"

[[routes]]
pattern = "apiv2.mirubato.com"
custom_domain = true

[[d1_databases]]
binding = "DB"
database_name = "mirubato-prod"
database_id = "31ecc854-aecf-4994-8bda-7a9cd3055122"

# Rate limiting configuration
[[unsafe.bindings]]
name = "RATE_LIMITER"
type = "ratelimit"
namespace_id = "1234"
simple = { limit = 10, period = 60 }