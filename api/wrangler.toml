name = "mirubato-api"
main = "src/index.ts"
compatibility_date = "2024-01-01"
compatibility_flags = ["nodejs_compat"]

[build]
command = "npm run build"

# Local development
[env.local]
vars = { ENVIRONMENT = "local", JWT_SECRET = "local-jwt-secret-for-development-only", MAGIC_LINK_SECRET = "local-magic-link-secret-for-development-only", GOOGLE_CLIENT_ID = "588179480764-kqduhkmbjh34po7kgfond5anarg1b4vm.apps.googleusercontent.com", API_URL = "http://api-mirubato.localhost:9797", FRONTEND_URL = "http://www-mirubato.localhost:4000", SCORES_URL = "http://scores-mirubato.localhost:9788", DICTIONARY_URL = "http://dictionary-mirubato.localhost:9799" }

# Observability
[env.local.observability.logs]
enabled = false

[[env.local.d1_databases]]
binding = "DB"
database_name = "mirubato-dev"
database_id = "local-db"  # Placeholder for local dev - wrangler will manage the actual file

[[env.local.kv_namespaces]]
binding = "MUSIC_CATALOG"
id = "music-catalog-local"

# Rate limiting for local development
[[env.local.unsafe.bindings]]
name = "RATE_LIMITER"
type = "ratelimit"
namespace_id = "1234"
simple = { limit = 10, period = 60 }

# Staging environment
[env.staging]
name = "mirubato-api-staging"
workers_dev = false
vars = { ENVIRONMENT = "staging", GOOGLE_CLIENT_ID = "588179480764-kqduhkmbjh34po7kgfond5anarg1b4vm.apps.googleusercontent.com", API_URL = "https://api-staging.mirubato.com", FRONTEND_URL = "https://staging.mirubato.com", SCORES_URL = "https://scores-staging.mirubato.com", DICTIONARY_URL = "https://dictionary-staging.mirubato.com" }

# Observability
[env.staging.observability.logs]
enabled = true

[[env.staging.routes]]
pattern = "api-staging.mirubato.com"
custom_domain = true

[[env.staging.d1_databases]]
binding = "DB"
database_name = "mirubato-dev"
database_id = "4510137a-7fdf-4fcd-83c9-a1b0adb7fe3e"

[[env.staging.kv_namespaces]]
binding = "MUSIC_CATALOG"
id = "b5c8ff95b5ab4ac7a1a632e6b1465f7d"

# Rate limiting for staging
[[env.staging.unsafe.bindings]]
name = "RATE_LIMITER"
type = "ratelimit"
namespace_id = "1234"
simple = { limit = 10, period = 60 }

# Production environment (default)
workers_dev = false

[vars]
ENVIRONMENT = "production"
GOOGLE_CLIENT_ID = "588179480764-kqduhkmbjh34po7kgfond5anarg1b4vm.apps.googleusercontent.com"
API_URL = "https://api.mirubato.com"
FRONTEND_URL = "https://mirubato.com"
SCORES_URL = "https://scores.mirubato.com"
DICTIONARY_URL = "https://dictionary.mirubato.com"

# Observability
[observability.logs]
enabled = true

[[routes]]
pattern = "api.mirubato.com"
custom_domain = true

[[d1_databases]]
binding = "DB"
database_name = "mirubato-prod"
database_id = "31ecc854-aecf-4994-8bda-7a9cd3055122"

[[kv_namespaces]]
binding = "MUSIC_CATALOG"
id = "b04ae504f7884fc180d27c9320b378f6"

# Rate limiting configuration
[[unsafe.bindings]]
name = "RATE_LIMITER"
type = "ratelimit"
namespace_id = "1234"
simple = { limit = 10, period = 60 }

# Explicit production environment config (for consistency)
[env.production]
name = "mirubato-api"
workers_dev = false

[env.production.vars]
ENVIRONMENT = "production"
GOOGLE_CLIENT_ID = "588179480764-kqduhkmbjh34po7kgfond5anarg1b4vm.apps.googleusercontent.com"
API_URL = "https://api.mirubato.com"
FRONTEND_URL = "https://mirubato.com"
SCORES_URL = "https://scores.mirubato.com"
DICTIONARY_URL = "https://dictionary.mirubato.com"

# Observability
[env.production.observability.logs]
enabled = true

[[env.production.routes]]
pattern = "api.mirubato.com"
custom_domain = true

[[env.production.d1_databases]]
binding = "DB"
database_name = "mirubato-prod"
database_id = "31ecc854-aecf-4994-8bda-7a9cd3055122"

[[env.production.kv_namespaces]]
binding = "MUSIC_CATALOG"
id = "b04ae504f7884fc180d27c9320b378f6"

[[env.production.unsafe.bindings]]
name = "RATE_LIMITER"
type = "ratelimit"
namespace_id = "1234"
simple = { limit = 10, period = 60 }