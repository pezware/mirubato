name = "mirubato-scores"
main = "src/index.ts"
compatibility_date = "2024-12-01"
compatibility_flags = ["nodejs_compat"]

# Browser Rendering binding
[browser]
binding = "BROWSER"

# Queue for PDF processing
[[queues.consumers]]
queue = "pdf-processing"
max_batch_size = 10
max_batch_timeout = 30
max_retries = 3
dead_letter_queue = "pdf-processing-dlq"

# Production configuration (default - no env flag needed)
vars = { ENVIRONMENT = "production", API_SERVICE_URL = "https://api.mirubato.com", FRONTEND_URL = "https://mirubato.com" }
routes = [
  { pattern = "scores.mirubato.com", custom_domain = true }
]

[[d1_databases]]
binding = "DB"
database_name = "mirubato-scores-production"
database_id = "aac4662e-d14a-4397-971c-c544d8c79104"

[[r2_buckets]]
binding = "SCORES_BUCKET"
bucket_name = "mirubato-scores-production"

[[kv_namespaces]]
binding = "CACHE"
id = "1f30ff61b4a04dc4a9a269ad6f828fe4"

[[queues.producers]]
binding = "PDF_QUEUE"
queue = "pdf-processing"

# Staging configuration
[env.staging]
name = "mirubato-scores-staging"
vars = { ENVIRONMENT = "staging", API_SERVICE_URL = "https://api-staging.mirubato.com", FRONTEND_URL = "https://staging.mirubato.com" }

[env.staging.browser]
binding = "BROWSER"

[[env.staging.routes]]
pattern = "scores-staging.mirubato.com"
custom_domain = true

[[env.staging.d1_databases]]
binding = "DB"
database_name = "mirubato-scores-staging"
database_id = "eb2baa9e-c67f-45e1-bf79-cd2cf781e92e"

[[env.staging.r2_buckets]]
binding = "SCORES_BUCKET"
bucket_name = "mirubato-scores-staging"

[[env.staging.kv_namespaces]]
binding = "CACHE"
id = "ecf57add945f48e2ad0ecaf2ca91ec95"

[[env.staging.queues.producers]]
binding = "PDF_QUEUE"
queue = "pdf-processing-staging"

# Development configuration
[env.dev]
name = "mirubato-scores-dev"
vars = { ENVIRONMENT = "development", API_SERVICE_URL = "https://api-staging.mirubato.com" }
routes = [
  { pattern = "scores-dev.pezware.workers.dev", zone_name = "pezware.workers.dev" }
]

[env.dev.browser]
binding = "BROWSER"

[[env.dev.d1_databases]]
binding = "DB"
database_name = "mirubato-scores-dev"
database_id = "bcb9546e-c5ef-43f7-a462-3472fa3fae89"

[[env.dev.r2_buckets]]
binding = "SCORES_BUCKET"
bucket_name = "mirubato-scores-dev"

[[env.dev.kv_namespaces]]
binding = "CACHE"
id = "395e4bee05ed4e68b15f35ba7b3ba832"

[[env.dev.queues.producers]]
binding = "PDF_QUEUE"
queue = "pdf-processing-dev"

# Local development configuration
[env.local]
vars = { ENVIRONMENT = "local", JWT_SECRET = "local-jwt-secret-for-development-only", FRONTEND_URL = "http://www-mirubato.localhost:4000", API_SERVICE_URL = "http://api-mirubato.localhost:9797", SCORES_URL = "http://scores-mirubato.localhost:9788" }

[env.local.browser]
binding = "BROWSER"

[[env.local.d1_databases]]
binding = "DB"
database_name = "mirubato-scores-local"
database_id = "local"

[[env.local.r2_buckets]]
binding = "SCORES_BUCKET"
bucket_name = "mirubato-scores-local"

[[env.local.kv_namespaces]]
binding = "CACHE"
id = "local"

# Note: Queues are not available in local development

# Explicit production environment (for consistency)
[env.production]
name = "mirubato-scores"
vars = { ENVIRONMENT = "production", API_SERVICE_URL = "https://api.mirubato.com", FRONTEND_URL = "https://mirubato.com" }

[env.production.browser]
binding = "BROWSER"

[[env.production.routes]]
pattern = "scores.mirubato.com"
custom_domain = true

[[env.production.d1_databases]]
binding = "DB"
database_name = "mirubato-scores-production"
database_id = "aac4662e-d14a-4397-971c-c544d8c79104"

[[env.production.r2_buckets]]
binding = "SCORES_BUCKET"
bucket_name = "mirubato-scores-production"

[[env.production.kv_namespaces]]
binding = "CACHE"
id = "1f30ff61b4a04dc4a9a269ad6f828fe4"

[[env.production.queues.producers]]
binding = "PDF_QUEUE"
queue = "pdf-processing"