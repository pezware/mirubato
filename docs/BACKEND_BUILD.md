# Mirubato Backend Build System

## Overview

The Mirubato backend uses a simplified, Cloudflare-native build system. This system lets Wrangler handle the build process directly, following Cloudflare best practices for Workers deployment.

## Architecture

### Simplified Build Pipeline

```
TypeScript Source → Wrangler Build → Deployment
        ↓                 ↓              ↓
   Standard TS        ESBuild +      Workers
   + GraphQL          Bundling       Runtime
```

### Key Principles

1. **Wrangler-First**: Let Wrangler handle TypeScript compilation and bundling
2. **No Build Hooks**: Avoid prebuild/postbuild complexity that causes loops
3. **Standard TypeScript**: Use standard `tsc` for local builds
4. **Simple Commands**: Each command has a single, clear purpose

## Commands

### Development

```bash
# Start development server (recommended)
npm run dev                # Runs: wrangler dev --env local

# Alternative development workflows
npm run dev:full          # Uses file watcher with auto-restart
npm run dev:watch         # TypeScript watch mode only
npm run dev:server        # Wrangler dev server only
```

### Production

```bash
# Production build
npm run build             # Runs: tsc

# Advanced build (with schema generation)
npm run dev:build         # Runs build-modern.js for special cases
```

### Deployment

```bash
# Deploy to different environments
npm run deploy:dev
npm run deploy:staging
npm run deploy:production

# Or use wrangler directly
wrangler deploy --env dev
```

## Environment Configuration

### Local Development (`--env local`)

- Uses placeholder database IDs
- Runs on localhost:8787
- Hot reload enabled via Wrangler

### Remote Environments

- `--env dev` - Development environment
- `--env staging` - Staging environment
- `--env production` - Production environment (default)

## Build Artifacts

### Wrangler-Generated Files

- `dist/index.js` - Main worker bundle (generated by Wrangler)
- Worker bindings (D1, KV) configured in `wrangler.toml`

### Source Files

- `src/schema/schema.graphql` - GraphQL schema definition
- TypeScript source files compiled automatically

## Troubleshooting

### Common Issues

1. **Build Fails with TypeScript Errors**

   ```bash
   # Check types without building
   npm run type-check

   # Generate types from wrangler
   npx wrangler types
   ```

2. **Missing Dependencies**

   ```bash
   # Clean install
   rm -rf node_modules package-lock.json
   npm install
   ```

3. **Wrangler Configuration Issues**
   ```bash
   # Validate wrangler config
   npx wrangler deploy --dry-run
   ```

### Debug Mode

Enable verbose logging for detailed build information:

```bash
npm run build -- --verbose
```

## Migration from Legacy Build

### Legacy Files (Archived)

- `build-legacy.js` (was `build.js`)
- `build-fixed-legacy.js` (was `build-fixed.js`)
- `build-with-lock-legacy.js` (was `build-with-lock.js`)

### Key Improvements

1. **Reliability**: No more manual file copying and path manipulation
2. **Performance**: Faster builds using standard TypeScript compilation
3. **Maintainability**: Clear separation of concerns
4. **Validation**: Proper build artifact verification
5. **Environment Parity**: Consistent behavior across local/cloud

## CI/CD Integration

The build system integrates with GitHub Actions for:

- Build validation on PRs
- Type checking
- Bundle size monitoring
- Deployment dry-runs

See `.github/workflows/backend-build-validation.yml` for details.

### Cloudflare Dashboard Settings

For proper deployment, configure your Cloudflare Worker with these settings:

**Build Configuration:**

- Build command: `npm run build`
- Deploy command: `cd backend && npx wrangler deploy` (for production/default environment)
- Root directory: `/` (repository root)
- Version command: **Leave empty** (unless using gradual deployments)

**Understanding Wrangler Environments:**

- Top-level config in `wrangler.toml` is the default (production)
- Named environments use `[env.<name>]` sections
- Deploy to specific env: `npx wrangler deploy --env staging`
- Environment creates worker named: `<base-name>-<env-name>`

**Why Version Command Should Be Empty:**

1. `wrangler versions upload` is for gradual rollouts, not direct deployment
2. Requires initial deployment with `wrangler deploy` first
3. Standard deployments should use `wrangler deploy` only

**For Environment-Specific Deployment:**
If you need to deploy to a specific environment from Cloudflare dashboard:

- Production branch deploy command: `cd backend && npx wrangler deploy`
- Non-production branch deploy command: `cd backend && npx wrangler deploy --env staging`

**Branch Deployment Settings:**

- Production branches use top-level config (default)
- Non-production branches deploy to `staging` environment
- This prevents accidental deployment to production from feature branches
- Development environment (`--env dev`) is reserved for local development

## Best Practices

### Development Workflow

#### Recommended: Simple Development

```bash
npm run dev
```

- Uses Wrangler's built-in file watching
- Automatic TypeScript compilation and hot reload
- No build configuration needed
- Best for most development scenarios

#### Advanced: File Watcher with Auto-restart

```bash
npm run dev:full
```

- Custom file watcher that handles GraphQL schema changes
- Automatically restarts server on file changes
- Good for complex development scenarios

#### Manual Control

```bash
# TypeScript compilation only
npm run build

# Development server (requires built files)
npm run dev:server
```

#### Testing and Validation

1. Use `npm run type-check` for quick type validation
2. Test deployment with `wrangler deploy --dry-run`
3. Check logs with `wrangler tail`

### Production Deployment

1. Ensure all tests pass locally
2. Verify build artifacts are generated correctly
3. Check bundle size for optimization opportunities
4. Use environment-specific deployment commands

**Important:** When deploying via Cloudflare dashboard:

- The build runs from repository root (not `/backend/`)
- TypeScript compiles to `backend/dist/`
- Deploy commands must `cd backend` first to find wrangler.toml and dist/
- Entry point is `dist/index.js` (relative to backend directory)

## Future Enhancements

- [ ] Re-enable `wrangler types` generation when stable
- [ ] Add bundle analysis and optimization suggestions
- [ ] Implement build caching for faster CI/CD
- [ ] Add source map generation for debugging
