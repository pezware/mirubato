# Mirubato Backend Worker Configuration
# This file defines all environments - no manual config generation needed
name = "mirubato-backend"
main = "dist/backend/src/index.js"
compatibility_date = "2024-09-23"
compatibility_flags = ["nodejs_compat"]

# Top-level configuration is production (default when no --env flag is used)
# This is used by Cloudflare's automated deployment system
workers_dev = false

[vars]
ENVIRONMENT = "production"

[observability]
enabled = true

[[d1_databases]]
binding = "DB"
database_name = "mirubato-prod"
database_id = "31ecc854-aecf-4994-8bda-7a9cd3055122"

[[kv_namespaces]]
binding = "MIRUBATO_MAGIC_LINKS"
id = "d323a9723d424eed9a8aab2b1b9e15b0"

# Build configuration - let wrangler handle TypeScript compilation
# No build command needed for simple TypeScript projects

[[routes]]
pattern = "api.mirubato.com"
custom_domain = true

# Local development configuration (for local dev server)
[env.local]
name = "mirubato-backend-local"
workers_dev = true
routes = []  # Override routes to prevent inheriting production routes

[env.local.vars]
ENVIRONMENT = "development"
JWT_SECRET = "test-jwt-secret-for-local-development"

[[env.local.d1_databases]]
binding = "DB"
database_name = "mirubato-dev"
database_id = "placeholder-for-local-dev"  # Local dev uses placeholder

[[env.local.kv_namespaces]]
binding = "MIRUBATO_MAGIC_LINKS"
id = "2632e7dcffe745f1a34ba6a3b029bd4c"  # Using preview namespace for debugging

[env.local.dev]
port = 8787
local_protocol = "http"

# Disable build command for local development to avoid loops
# [env.local.build]
# command = "tsc && node scripts/build-modern.js --post"
# watch_paths = ["src/**/*.ts", "src/**/*.graphql"]

# Preview/Dev environment (for wrangler deploy --env dev)
[env.dev]
name = "mirubato-backend-dev"
workers_dev = true

[env.dev.vars]
ENVIRONMENT = "development"

[[env.dev.d1_databases]]
binding = "DB"
database_name = "mirubato-dev"
database_id = "4510137a-7fdf-4fcd-83c9-a1b0adb7fe3e"

[[env.dev.kv_namespaces]]
binding = "MIRUBATO_MAGIC_LINKS"
id = "2632e7dcffe745f1a34ba6a3b029bd4c"

# Development environment uses default wrangler build

# Production environment
[env.production]
name = "mirubato-backend"
workers_dev = false

[env.production.vars]
ENVIRONMENT = "production"

[[env.production.d1_databases]]
binding = "DB"
database_name = "mirubato-prod"
database_id = "31ecc854-aecf-4994-8bda-7a9cd3055122"

[[env.production.kv_namespaces]]
binding = "MIRUBATO_MAGIC_LINKS"
id = "d323a9723d424eed9a8aab2b1b9e15b0"

# Production environment uses default wrangler build

[[env.production.routes]]
pattern = "api.mirubato.com"
custom_domain = true