#!/usr/bin/env node

import fs from 'fs'
import path from 'path'
import { fileURLToPath } from 'url'
import crypto from 'crypto'

const __filename = fileURLToPath(import.meta.url)
const __dirname = path.dirname(__filename)

// Read template files
const templatesDir = path.join(__dirname, '../src/templates/email')
const outputFile = path.join(
  __dirname,
  '../src/templates/email/compiled-templates.ts'
)

const htmlTemplate = fs.readFileSync(
  path.join(templatesDir, 'magic-link.html'),
  'utf-8'
)
const textTemplate = fs.readFileSync(
  path.join(templatesDir, 'magic-link.txt'),
  'utf-8'
)

// Generate TypeScript module with template content
const output = `// This file is auto-generated by scripts/build-email-templates.js
// Do not edit manually

export const MAGIC_LINK_HTML_TEMPLATE = \`${htmlTemplate.replace(/\\/g, '\\\\').replace(/`/g, '\\`').replace(/\$/g, '\\$')}\`

export const MAGIC_LINK_TEXT_TEMPLATE = \`${textTemplate.replace(/\\/g, '\\\\').replace(/`/g, '\\`').replace(/\$/g, '\\$')}\`
`

// Check if file exists and content is different
let shouldWrite = true
if (fs.existsSync(outputFile)) {
  const existingContent = fs.readFileSync(outputFile, 'utf-8')
  const existingHash = crypto
    .createHash('sha256')
    .update(existingContent)
    .digest('hex')
  const newHash = crypto.createHash('sha256').update(output).digest('hex')
  shouldWrite = existingHash !== newHash
}

// Only write if content is different
if (shouldWrite) {
  fs.writeFileSync(outputFile, output)
  console.log('Email templates compiled successfully!')
} else {
  console.log('Email templates unchanged, skipping write.')
}
